import "dart:math" as WB;import "dart:async" as jC;import "dart:html" as FB;class ZD{static const  aD="Chrome";static const  bD="Firefox";static const  cD="Safari";final  DD;final  minimumVersion;const ZD(this.DD,[this.minimumVersion]);}class dD{final  name;const dD(this.name);}class p extends n{var x,y;p(this.x,this.y);}class gD extends bB{var HB;var q;var gC;gD(this.HB):super(s.dB([p,uB]));initialize(){q=new u<p>(p,k);gC=new u<uB>(uB,k);}AC(){HB.clear(color:'green');}VB(h){var j=q.get(h);var l=gC.get(h);var g=NC[l.name];HB.drawImage(g,j.x-g.width~/2,j.y-g.height~/2);}}class fD extends mB{var KC;var FC;var BB=new Map<int,bool>();initialize(){var h=k.LB(DB);var g=h.eB(YB);KC=g.GC(IB);FC=g.GC(GB);FB.window.onKeyDown.listen((g)=>BB[g.keyCode]=true);FB.window.onKeyUp.listen((g)=>BB[g.keyCode]=false);}hB(){KC.x=right?0.2:left?-0.2:0;KC.y=ID?0.2:VD?-0.2:0;FC.iB=FC.rB&&iB;}get left=>BB[FB.KeyCode.LEFT]==true||BB[FB.KeyCode.A]==true;get right=>BB[FB.KeyCode.RIGHT]==true||BB[FB.KeyCode.D]==true;get VD=>BB[FB.KeyCode.UP]==true||BB[FB.KeyCode.W]==true;get ID=>BB[FB.KeyCode.DOWN]==true||BB[FB.KeyCode.S]==true;get iB=>BB[FB.KeyCode.CTRL]==true||BB[FB.KeyCode.J]==true;}class eD extends bB{var q;var iC;eD():super(s.dB([p,IB]));initialize(){q=new u<p>(p,k);iC=new u<IB>(IB,k);}VB(g){var h=q.get(g);var j=iC.get(g);h.x+= j.x*k.TB;h.y+= j.y*k.TB;}}class uB extends n{var name;uB(this.name);}class IB extends n{var x,y;IB({this.x: 0,this.y: 0});}class GB extends n{var rB=true,iB=false;var EC=0,fC=100;var ZC;var BC='bullet';GB(this.ZC);}const CB=500;const OB=600;const XB=-16;const vB=OB-XB;class kC{var offsetX,offsetY,velocity,angle;kC({this.offsetX: 0,this.offsetY: 0,this.velocity: 0.5,this.angle: 0});}const lC=vB-XB;const YB='player';class hD extends mB{const WC=20;const XC=50;const UC=CB-20;const VC=OB-30;var UB;initialize(){var h=k.LB(DB);var g=h.eB(YB);UB=g.GC(p);}hB(){var h=UB.x;var g=UB.y;if(h<WC){UB.x=WC;}else if(h>UC){UB.x=UC;}if(g<XC){UB.y=XC;}else if(g>VC){UB.y=VC;}}}const MC='enemy';class ZB extends n{var hp,JC;ZB({this.hp: 10}){JC=hp;}}const mC='enemy-bullet';const nC='bullet';var NC=new Map<String,FB.ImageElement>();class oC extends n{}class iD extends mB{var NB;var MB;var HB;iD(this.HB);initialize(){NB=k.LB(DB);MB=new u<ZB>(ZB,k);}hB(){var h=NB.eB(YB);HB..fillStyle='#140c1c'..font='18px Verdana'..fillText('Score: ${JB}',10,OB-25)..fillRect(CB/4,OB-20,CB/2,20);if(null!=h){var g=MB.get(h);HB..fillStyle='#6daa2c'..fillRect(CB/4+2,OB-18,(CB/2-4)*g.hp/g.JC,16);}}AC(){HB.save();}end(){HB.restore();}}class OC extends n{}var v=new WB.Random();var JB=0; main(){FB.window.setImmediate((){var h=rC('#game');h.canvas..width=CB..height=OB;h.textBaseline='top';var t=['player','bullet','tree-0','tree-1','tree-2','tree-3','enemy-0','enemy-1','enemy-2','enemy-3','enemy-bullet'];var l=new List<jC.Future>();t.forEach((j){var g=new FB.ImageElement();NC[j]=g;g.src='res/${j}.png';l.add(g.onLoad.first);});jC.Future.wait(l).then((uD){new kD().start(h);});});}class jD extends bB{var fB;var q;var hC;var EB;jD():super(s.dB([p,IB,GB]));initialize(){fB=new u<GB>(GB,k);q=new u<p>(p,k);hC=new u<IB>(IB,k);EB=k.LB(cB);}VB(h){var g=fB.get(h);if(!g.rB){if(g.EC>0){g.EC-= k.TB;}else{g.rB=true;}}else if(g.iB){var l=q.get(h);var t=hC.get(h);g.ZC.forEach((j){var h=k.tB();h.o(new p(l.x+j.offsetX,l.y+j.offsetY));h.o(new IB(x:j.velocity*WB.cos(j.angle),y:t.y+j.velocity*WB.sin(-j.angle)));h.o(new uB(g.BC));h.o(new ZB(hp:1));h.pB();EB.add(h,g.BC);});g.EC=g.fC;g.rB=false;}}}class kD{var k=new nB();var IC; start( h){var j=new DB();var l=new cB();k.oB(j);k.oB(l);GD();var g=k.tB();g.o(new p(CB~/2,OB*7/8));g.o(new uB('player'));g.o(new IB());g.o(new GB([new kC(offsetX:-3,offsetY:-16,angle:WB.PI/2),new kC(offsetX:3,offsetY:-16,angle:WB.PI/2)]));g.o(new ZB(hp:20));g.pB();j.register(g,YB);k.AB(new qD());k.AB(new fD());k.AB(new eD());k.AB(new hD());k.AB(new oD());k.AB(new jD());k.AB(new pD());k.AB(new lD());k.AB(new mD());k.AB(new gD(h));k.AB(new iD(h));k.AB(new nD());k.initialize();FB.window.animationFrame.then((t){IC=t;FB.window.animationFrame.then(dC);});}GD(){for(int h=0;h<40;h++ ){var g=k.tB();g.o(new p(v.nextInt(CB),XB+v.nextInt(lC)));g.o(new uB('tree-${v.nextInt(4)}'));g.o(new IB(y:0.08));g.o(new OC());g.pB();}} dC( g){k.TB=g-IC;IC=g;k.process();FB.window.animationFrame.then(dC);}}class lD extends bB{var q;lD():super(s.dB([p]).KD([OC]));initialize(){q=new u<p>(p,k);}VB( g){var h=q.get(g);if(h.y>vB||h.y<XB){g.cC();}}}class mD extends bB{var q;mD():super(s.dB([p,OC]));initialize(){q=new u<p>(p,k);}VB( h){var g=q.get(h);if(g.y>vB){g.y=XB;g.x=v.nextInt(CB);}}}class nD extends SC{var EB;nD():super(2500,s.zB());initialize(){EB=k.LB(cB);}gB(uD){for(int g=0;g<1+v.nextInt(1+JB~/250);g++ ){UD();}} UD(){var g=k.tB();g.o(new p(v.nextInt(CB),-v.nextInt(-XB)));var l=v.nextInt(4);g.o(new uB('enemy-${l}'));var h=0.05+v.nextDouble()/20+JB/10000;var j;switch (l){case 0:case 1:j=new GB([new kC(offsetX:0,offsetY:16,angle:WB.PI*3/2,velocity:h)]);break;case 2:j=new GB([new kC(angle:WB.PI*3/2,velocity:h),new kC(angle:WB.PI*5/4,velocity:h),new kC(angle:WB.PI*7/4,velocity:h)]);break;case 3:j=new GB([new kC(angle:WB.PI,velocity:h),new kC(angle:0,velocity:h)]);break;}j.fC=1000+v.nextInt(20000)-JB/500;j.BC='enemy-bullet';g.o(j);g.o(new IB(y:0.01+v.nextDouble()/10+JB/10000));g.o(new oC());g.o(new OC());g.o(new ZB(hp:1+v.nextInt(4)+JB~/500));g.pB();EB.add(g,MC);}}class oD extends bB{var fB;oD():super(s.dB([oC,GB]));initialize(){fB=new u<GB>(GB,k);}VB( g){var h=fB.get(g);h.iB=true;}}class pD extends mB{var EB;var NB;var q;var MB;initialize(){EB=k.LB(cB);NB=k.LB(DB);q=new u<p>(p,k);MB=new u<ZB>(ZB,k);}hB(){var t=EB.HC(nC);var j=EB.HC(mC);var h=EB.HC(MC);var g=NB.eB(YB);h.forEach((l){DC(l,t,3,addScore:true);});if(null!=g){DC(g,j,3);DC(g,h,16);}} DC( g, LC, t,{ addScore: false}){var j=q.get(g);LC.forEach((h){var l=q.get(h);if(tC.yC(j.x,j.y,16,l.x,l.y,t)){eC(g,addScore);eC(h,false);}});} eC( g, j){var h=MB.get(g);h.hp-= 1;if(h.hp==0){g.cC();if(j){JB+= 4;}}else if(j){JB+= 1;}}}class qD extends SC{var NB;var MB;qD():super(5000,s.zB());initialize(){NB=k.LB(DB);MB=new u<ZB>(ZB,k);}gB(uD){var h=NB.eB(YB);if(null!=h){var g=MB.get(h);if(g.hp<g.JC){g.hp+= 1;}}}}class pC{static  sC( g){var h=new FB.CanvasElement(width:g.width,height:g.height);h.context2D.drawImage(g,0,0);return h;}}class qC{final  bC;qC.rD(this.bC); get vD=>bC.canvas; get onKeyDown=>FB.document.onKeyDown.map((g)=>g.keyCode); get onKeyUp=>FB.document.onKeyUp.map((g)=>g.keyCode);} rC([var selector, height]){var g;if(null==selector||selector is int){var h=(selector!=null?selector:FB.window.innerWidth);height=(height!=null?height:FB.window.innerHeight);g=new FB.CanvasElement(width:h,height:height);}else if(selector is String){g=FB.query(selector);}else if(selector is FB.ImageElement){g=pC.sC(selector);}else if(selector is aB){return selector;}else{g=selector;}return new aB(g);}class aB implements FB.CanvasRenderingContext2D{var vD;var wD;var xD; get canvas=>vD;aB(this.vD){wD=vD.context2D;xD=new qC.rD(this);} noSuchMethod( g)=>g.invokeOn(wD); clear({ color}){if(null!=color){wD.fillStyle=color;wD.fillRect(0,0,vD.width,vD.height);}else{wD.clearRect(0,0,vD.width,vD.height);}}}abstract class PC{ qB( g); CC( g); SB( g); enabled( g); disabled( g);}class wB extends KB{var yD;var AE;var GE;var HE=0;var IE=0;var JE=0;var DE=0;var PE;wB():yD=new m<i>(),AE=new m<i>(),GE=new m<bool>(),PE=new zC(); initialize(){} mE(){var g=AE.removeLast();if(null==g){g=new i.tD(BE,PE.ED());}JE++ ;return g;} qB( g){HE++ ;IE++ ;yD[g.id]=g;} enabled( g){GE[g.id]=false;} disabled( g){GE[g.id]=true;} SB( g){yD[g.id]=null;GE[g.id]=false;AE.add(g);HE-- ;DE++ ;} zE( g)=>yD[g];}class jB{static var RC=new Map<Type,PB>();static  lB( h){var g=RC[h];if(g==null){g=new PB();RC[h]=g;}return g;}static  xC( g)=>lB(g).YC;}class PB{static var yB=1;static var vC=0;var CE=0;var EE=0;PB(){CE=yB;yB=yB<<1;EE=vC++ ;} get YC=>CE; get id=>EE;}class xB extends KB{var zD;var DE;xB():zD=new m<m<n>>(),DE=new m<i>(); initialize(){} TE( g){XE(g,(h,j){h[g.id].WE();h[g.id]=null;});g.eE=0;} jE( j, l, t){var h=l.id;zD.pE(h);var g=zD[h];if(g==null){g=new m<n>();zD[h]=g;}g[j.id]=t;j.uE(l.YC);} ND( j){var h=j.id;zD.pE(h);var g=zD[h];if(g==null){g=new m<n>();zD[h]=g;}return g;} AF( h, l){var j=l.id;var g=zD[j];if(g!=null){return g[h.id];}return null;} XE( j, l( components, index)){var g=j.eE;var h=0;while (g>0){if((g&1)==1){l(zD[h],h);}h++ ;g=g>>1;}} SB( g)=>DE.add(g); FD(){DE.forEach((g)=>TE(g));DE.clear();}}class uC{static var QC=0;static var kB;static  wC( h){if(null==kB){kB=new Map<Type,int>();}var g=kB[h];if(g==null){g=1<<QC;QC++ ;kB[h]=g;}return g;}}class tC{static  yC( WD, l, t, LC, XD, YD){var g=LC-WD;var j=XD-l;var h=t+YD;return (g*g+j*j)<(h*h);}}abstract class KB implements PC{var BE; initialize(); qB( g){} CC( g){} SB( g){} disabled( g){} enabled( g){}}class QB<w>{var FE;QB.sD(this.FE); operator[]( g)=>FE[g]; get size=>FE.size; get isEmpty=>FE.isEmpty; contains( g)=>FE.contains(g); forEach( g( element))=>FE.forEach(g);}class i{final  id;var cE=0;var eE=0;var kB=0;var BE;var VE;var aE;i.tD(this.BE,this.id){VE=BE.JD;aE=BE.aC;} uE( g){eE|= g;} wE( g){kB|= g;} xE( g){kB&= ~g;} toString()=>"Entity[${id}]"; o( g){aE.jE(this,jB.lB(g.runtimeType),g);} MD( g){return aE.AF(this,g);} GC( g){return MD(jB.lB(g));} pB()=>BE.AD(this); cC()=>BE.HD(this);}abstract class bB extends RB{bB( g):super(g); VB( g); gB( h)=>h.forEach((g)=>VB(g)); sB()=>true;}abstract class SC extends RB{var ME=0;var QE=0;final  SE; get TB=>QE;SC(this.SE, g):super(g); sB(){ME+= k.TB;QE+= k.TB;if(ME>=SE){ME-= SE;return true;}return false;} end(){QE=0;}}class u<TC extends n>{var NE;var RE;u( h, g){this.NE=jB.lB(h);RE=g.aC.ND(this.NE);}TC get( g)=>RE[g.id] as TC;}class m<w>{var KE;var LE=0;var OE;m({ capacity: 16}):KE=new List(capacity){OE=new QB.sD(this);} operator[]( g)=>KE[g]; get size=>LE; get readOnly=>OE; get isEmpty=>LE==0; forEach( h( element)){for(int g=0;g<LE;g++ ){h(KE[g]);}} removeLast(){if(LE>0){var g=KE[ --LE];KE[LE]=null;return g;}return null;} remove( j){for(int g=0;g<LE;g++ ){var h=KE[g];if(j==h){KE[g]=KE[ --LE];KE[LE]=null;return true;}}return false;} contains( h){for(int g=0;LE>g;g++ ){if(h==KE[g]){return true;}}return false;} add( g){if(LE==KE.length){HF();}KE[LE++ ]=g;} operator[]=( g, h){if(g>=KE.length){IF(g*2);}LE=g+1;KE[g]=h;} HF(){var g=((KE.length*3)/2+1).toInt();IF(g);} IF( h){var g=KE;KE=new List<w>(h);KE.setRange(0,g.length,g);} pE( g){if(g>=KE.length){IF(g*2);}} clear(){for(int g=0;g<LE;g++ ){KE[g]=null;}LE=0;} addAll( h){for(int g=0;h.size>g;g++ ){add(h[g]);}} toString()=>"[${KE.join(',')}]";}abstract class n{ WE(){}}class DB extends KB{final  UE;final  YE;DB():UE=new Map<String,i>(),YE=new Map<i,String>(); register( g, h){UE[h]=g;YE[g]=h;} unregister( g){YE.remove(UE.remove(g));} eB( g)=>UE[g]; SB( h){var g=YE.remove(h);if(g!=null){UE.remove(g);}} initialize(){}}abstract class mB extends RB{mB():super(s.zB()); gB( g)=>hB(); hB(); sB()=>true;}class nB{final  VE=new wB();final  aE=new xB();final  IE=new m<i>();final  hE=new m<i>();final  DE=new m<i>();final  oE=new m<i>();final  qE=new m<i>();final  rE=new Map<Type,RB>();final  sE=new List<RB>();final  tE=new Map<Type,KB>();final  vE=new m<KB>();var TB;nB(){oB(VE);oB(aE);} initialize(){vE.forEach((h)=>h.initialize());sE.forEach((g)=>g.initialize());} get JD=>VE; get aC=>aE; oB( g){tE[g.runtimeType]=g;vE.add(g);g.BE=this;} LB( g){return tE[g];} tB(){return VE.mE();} eB( g){return VE.zE(g);} AB( g,{ passive: false}){g.k=this;g.nE=passive;rE[g.runtimeType]=g;sE.add(g);return g;} BF( j, h(EntityObserver,Entity)){j.forEach((g){vE.forEach((l)=>h(l,g));sE.forEach((t)=>h(t,g));});j.clear();} process(){RD();sE.forEach((g){if(!g.QD){g.process();}});} RD(){BF(IE,(h,g)=>h.qB(g));BF(hE,(h,g)=>h.CC(g));BF(qE,(h,g)=>h.disabled(g));BF(oE,(h,g)=>h.enabled(g));BF(DE,(h,g)=>h.SB(g));aE.FD();} AD( g)=>IE.add(g); HD( g){if(!DE.contains(g)){DE.add(g);}}}class cB extends KB{final  ZE;final  bE;cB():ZE=new Map<String,m<i>>(),bE=new Map<i,m<String>>(); initialize(){} add( j, l){var h=ZE[l];if(h==null){h=new m<i>();ZE[l]=h;}h.add(j);var g=bE[j];if(g==null){g=new m<String>();bE[j]=g;}g.add(l);} SD( h){var g=bE[h];if(g!=null){g.forEach((l){var j=ZE[l];if(j!=null){j.remove(h);}});g.clear();}} HC( h){var g=ZE[h];if(g==null){g=new m<i>();ZE[h]=g;}return g.readOnly;} SB( g)=>SD(g);}abstract class RB implements PC{var dE=0;var k;var fE;var gE;var iE;var kE;var lE;var nE;RB( g):fE=new m<i>(),gE=g.BD,iE=g.LD,kE=g.PD{lE=gE==0&&kE==0;dE=uC.wC(runtimeType);}get QD=>nE; AC(){} process(){if(sB()){AC();gB(fE.readOnly);end();}} end(){} gB( g); sB(); initialize(){} OD( g){} TD( g){} BF( g){if(lE){return;}var j=CF(g);var h=(gE&g.eE)==gE;if(kE>0&&h){h=(kE&g.eE)>0;}if(iE>0&&h){h=(iE&g.eE)==0;}if(h&&!j){FF(g);}else if(!h&&j){GF(g);}} CF( g)=>(dE&g.kB)==dE; FF( g){fE.add(g);g.wE(dE);OD(g);} GF( g){fE.remove(g);g.xE(dE);TD(g);} qB( g)=>BF(g); CC( g)=>BF(g); enabled( g)=>BF(g); SB( g){if(CF(g)){GF(g);}} disabled( g){if(CF(g)){GF(g);}}}class s{var gE=0;var iE=0;var kE=0; CD( g){gE=yE(gE,g);return this;} KD( g){iE=yE(iE,g);return this;}static  dB( h){var g=new s();g.CD(h);return g;}static  zB()=>new s(); get BD=>gE; get LD=>iE; get PD=>kE; yE( g, h){if(null!=h){h.forEach((j){g=g|jB.xC(j);});}return g;}}class zC{var DF;var EF=0;zC():DF=new m<int>(); ED(){if(DF.size>0){return DF.removeLast();}return EF++ ;}}//@ sourceMappingURL=out.dart.map
